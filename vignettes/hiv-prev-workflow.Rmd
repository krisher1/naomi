---
title: "HIV prevention prioritization tool"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{HIV prevention prioritization tool workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, warning = FALSE, results = 'asis'}
library(tibble)
library(gt)
library(naomi)
```

## Background

Many HIV prevention programmes aim to reduce new infections but is not feasible to target all individuals living in locations with HIV incidence. In different geographic settings, with different background incidence, sexual behaviours confer different levels of risk of HIV infection. 

Recent HIV programming guidance introduces thresholds for prioritization considering both HIV incidence and sexual behaviours to reach the largest population at risk of HIV. This tool provides the “denominator” for HIV prevention categorised by sex, age, geography, and sexual behaviour.

## Data inputs

These categorizations are calculated using subnational estimates of PLHIV burden by age and sex produced by the Naomi model. [Naomi](https://github.com/mrc-ide/naomi) is a small-area estimation model for estimating HIV prevalence and PLHIV, ART coverage, and new HIV infections at district level by sex and five-year age group. The model combines district-level data about multiple outcomes from several sources in a Bayesian statistical model to produce robust indicators of subnational HIV burden. Naomi is used to annual update estimates of subnational HIV burden as part of the [UNAIDS HIV estimates process](https://www.unaids.org/en/dataanalysis/knowyourresponse/HIVdata_estimates).

The tool synthesises the most recent estimates of subnational PLHIV with outputs from additional mathematical models 
describing subnational variation in sexual risk behaviour and estimates of key populations at an elevated risk of HIV infection:

* **[Howes et al.](https://journals.plos.org/globalpublichealth/article?id=10.1371/journal.pgph.0001731)** model estimating subnational prevalence of HIV risk behaviours and associated HIV incidence. 
* **[Stevens et al.](https://www.medrxiv.org/content/10.1101/2022.07.27.22278071v2)** model for population size estimates (PSEs) of key population in sub-Saharan Africa, including female sex workers (FSW), men-who-have-sex-with-men (MSM) and people who inject drugs (PWID).
* **[Nguyen et al.](https://bmcpublichealth.biomedcentral.com/articles/10.1186/s12889-022-13451-y)**: model for age of sexual debut sub-Saharan Africa.

These outputs of these models are stored in an external repository, [naomi-resources](http://github/mrc-ide/naomi.resources) and are updated regularly to incorporate newly released survey data and to align with changes in geographic changes in country specific administrative boundaries required for planning.

In addition to estimates produced by subnational models, the tool incorporates consensus estimates of KP population size that are developed by national HIV estimates teams as part of the annual UNAIDS HIV estimates process. For more information on this exercise please see [14G Key Population Workbook](https://hivtools.unaids.org/hiv-estimates-training-material-en/).

## Tool workflow

This tool is now integrated into the [Naomi web application](https://naomi.unaids.org/login) and is generated after completing Naomi model as described in [22G Naomi sub-national estimates: Creating subnational HIV estimates](https://hivtools.unaids.org/hiv-estimates-training-material-en/).

If you are running a Naomi model fit with updated administrative boundaries, you may receive an error that the external database containing the SRB or KP PSE model is out of date:

```{r, echo = FALSE, results = 'asis', warning = FALSE}

cat("Error: Available KP PSE estimates for: \n",
                     "MWI_1_1; MWI_1_2; MWI_1_3",
                     "\n\n Do not match Naomi estimates for: \n",
                     "MWI_1_1xc; MWI_2_25d; MWI_2_3cv",
                     "\n\nTo update estimates, please contact Naomi support.")
```

## HIV prevention need calculation

**1.Calculate key population sizes by district and age**: 

Regional KP proportion estimates from [Stevens et al.](https://www.medrxiv.org/content/10.1101/2022.07.27.22278071v2) are disaggregated by age and district. 

  * _Calculating sexually active population by age and sex_: Country specific estimates of age of first sexual debut are applied to district level population estimates from Naomi:
    * For age distribution of MSM and women who sell sex, we assume a combination of:
      * Age at first sex from [Nguyen et al.](https://bmcpublichealth.biomedcentral.com/articles/10.1186/s12889-022-13451-y)
      * Age-specific MSM and FSW propensity estimates from [Thembisa](https://www.thembisa.org/content/downloadPage/Thembisa4_3) of:
        * MSM: Mean age of 25, SD 7
        * FSW: Mean age of 29, SD 9
    * For age distribution of PWID literature estimate of age distribution from [Hines et al](web)
        * PWID: Mean age 29.4, SD 7
  * _Calculating total KP population by age_: Country specific regional KP proportions from the _Stevens et al_ model are applied to district level population estimates from Naomi and adjusted by age distribution of sexually active population calculated above.
    * This includes an assumption that a nominal number of PWID (~9%) are female and as a result these are removed from the denominator and PWID are assumed as male from this point onwards.
    
  
**2. Separate general population sexual risk behaviour groups removing KP populations calculated in (1)**:

```{r, echo = FALSE, results = 'asis', warning = FALSE}

tibble::tribble(
  ~"SRB category", ~ "HIV related risk", 
  "Low: No sex", "Not sexually active", 
  "Mid: One regular", "Sexually active, one cohabiting partner", 
  "High: Non-regular", "Non-regular sexual partner(s)", 
  "KPs", "FSW, MSM and PWID"
) %>%
  gt() %>%
  tab_header("HIV prevention priority groups") %>%
  gt::tab_options(
    table.align = "left",
    heading.align = "left",
    column_labels.font.size = "small",
    column_labels.background.color = "grey",
    table.font.size = "smaller",
    data_row.padding = gt::px(3),
    row_group.background.color = "lightgrey"
  )

```

Subtract the proportion of KPs from low, mid and high sexual risk behaviour groups estimated in _Risher et al_ model:

  * FSWs only subtracted from high risk SRB group of females aged 15-49.
  * MSM and PWID subtracted proportionally from all male SRB groups.

**3. Calculate risk group logit prevalence**

To calculate HIV prevalence for specific sexual risk behaviour groups by district and age, we maintain
HIV prevalence from Naomi for a district-age-sex, but disaggregate to different
risk behaviours using HIV prevalence ratios from household surveys for those reporting no
sex vs one cohabiting vs non-regular sexual partner(s).

* Prevalence ratios by behaviour group are used to distribute PLHIV between behavioural risk groups.
* Household survey data is used to estimate HIV prevalence in the no sex, one regular and non-regular partner(s) groups to calculate log odds-ratios for each behavioural category.
* HIV prevalence ratio for KPs is based on the ratio of KP HIV prevalence1 to HIV prevalence among all women (FSW) or men (MSM and PWID).
* HIV prevalence by behaviour is not explicitly presented – it is used to subtract off population sizes to present population susceptible to HIV (HIV-negative) in the previous caclculation step.


_For females, this is adjusted by:_

  * A linear regression through admin-1 level estimates of the ratio of KP prevalence to gen-pop prevalence used to predict an age-district-specific FSW to general population prevalence ratio.
  
_For males this this is adjusted by:_

  * Admin-1 level estimates of the ratio of KP prevalence to gen-pop prevalence among 15-24 year olds for MSM (due to the young age distribution of MSM) or among 15-49 year olds for PWID (due to the older age distribution of PWID) applied to all age groups among MSM and PWID in districts by admin-1 unit.
  
**3. Calculate risk group incidence and new infections**

While maintaining age/sex/district-specific HIV incidence from Naomi, distribute HIV incidence between our 4 different behavioural groups utilizing IRRs from the literature:

* Risk ratios for non-regular sex partners relative to those with a single cohabiting sex partner for females <sup>_1,2,3_</sup> and males <sup>_1,2,4_</sup>. 
* For FSW, ratio of HIV incidence among women in key populations vs single cohabiting partner women derived based on HIV incidence category in district and tiered risk ratio <sup> 5 </sup>. 
* For MSM and PWID, using ddmin 1 KP prevalence estimates relative to general population prevalence <sup>6</sup> and estimates from systematic review & meta-regression <sup> 7 </sup>.


Number of new infections by risk group is derived by multiplying these estimated incidence rates by risk behaviour times the population sizes of HIV-negative individuals by risk behaviour, in each of the 5-year age groups

```{r, echo = FALSE, results = 'asis', warning = FALSE}

tibble::tribble(
  ~"SRB category", ~ "Females",  ~"Males" , 
  "Low: No sex", "0", "0", 
  "Mid: One regular", "1 (reference category)", "1 (reference category)", 
  "High: Non-regular",
  "_Aged 15-24_: 1.72 <br> Aged 25-49: 2.1 <sup>_1,2,3_</sup>", 
  "_Aged 15-24_: 1.89 <br> Aged 25-49: 2.1 <sup>_1,2,4_</sup>", 
  "KPs", 
  "**FSW**: <br> Very high: 3 <br> High: 6 <br>Moderate: 9 <br>Low: 13 <br>Very low: 25 <sup>_5_</sup>",
  "**MSM**: 2.5-250<sup>_6,7_</sup> <br> **PWID** 2.5-55 <sup>_6_</sup>"
) %>%
  gt() %>%
    gt::tab_options(
    table.align = "left",
    heading.align = "left",
    column_labels.font.size = "small",
    column_labels.background.color = "grey",
    table.font.size = "smaller",
    data_row.padding = gt::px(3),
    row_group.background.color = "lightgrey"
  ) %>%
  fmt_markdown(columns = everything())

```





<sup> 1 </sup> ALPHA Network pooled analysis (Slaymaker et al. CROI 2020)

<sup> 2 </sup> [Jia et al. 2022](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8743366/)

<sup> 3 </sup> [Ssempijja et al. 2022](https://journals.lww.com/jaids/fulltext/2022/07010/high_rates_of_pre_exposure_prophylaxis_eligibility.7.aspx).

<sup> 4 </sup> [Hoffman et al. 2022](https://journals.lww.com/jaids/Fulltext/2022/06001/Implementing_PrEP_Services_in_Diverse_Health_Care.15.aspx)

<sup> 5 </sup> [Jones et al. 2023](https://www.medrxiv.org/content/10.1101/2023.10.17.23297108v2)

<sup> 6 </sup> [Stevens et al. 2023](https://www.medrxiv.org/content/10.1101/2022.07.27.22278071v2)

<sup> 7 </sup> [Stannah et al. 2022](https://www.medrxiv.org/content/10.1101/2022.11.14.22282329v1)



## Limitations of tool

Risk behaviour population size estimates at a district level have a high degree of uncertainty, which is not captured in the current version of the tool

Uncertainty in:

* KP sizes and their age and geographical disaggregation
* Small area estimates based on survey data
* Behavioural reports in surveys
* Incidence rate ratios by behaviour
* Naomi estimates

PSEs should be considered indicative rather than exact 



## Usage of tool outputs

Usage of tool output for prioritising groups for HIV prevention can be found [on the UNAIDS website](https://hivtools.unaids.org/pse/).

